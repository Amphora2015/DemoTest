IF OBJECT_ID('ConfirmMgr.V_ASSOCIATED_DOCS','V') IS NOT NULL
EXEC('DROP VIEW ConfirmMgr.V_ASSOCIATED_DOCS')
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW ConfirmMgr.V_ASSOCIATED_DOCS
 (
   ID, 
   INBOUND_DOCS_ID, 
   INDEX_VAL, 
   FILE_NAME, 
   TRADE_ID, 
   DOC_STATUS_CODE, 
   ASSOCIATED_BY, 
   ASSOCIATED_DT, 
   FINAL_APPROVED_BY, 
   FINAL_APPROVED_DT, 
   DISPUTED_BY, 
   DISPUTED_DT, 
   DISCARDED_BY, 
   DISCARDED_DT, 
   VAULTED_BY, 
   VAULTED_DT, 
   CDTY_GROUP_CODE, 
   CPTY_SN, 
   BROKER_SN, 
   DOC_TYPE_CODE, 
   SEC_VALIDATE_REQ_FLAG, 
   TRADE_RQMT_ID, 
   TRADEIDS, 
   UNRESOLVEDCOUNT, 
   XMIT_STATUS_CODE, 
   XMIT_VALUE)
AS 
   
/*Generated by SQL Server Migration Assistant for Oracle version 5.3.0.*/
   SELECT 
      ad.ID, 
      ad.INBOUND_DOCS_ID, 
      ad.INDEX_VAL, 
      ad.FILE_NAME, 
      ad.TRADE_ID, 
      ad.DOC_STATUS_CODE, 
      ad.ASSOCIATED_BY, 
      ad.ASSOCIATED_DT, 
      ad.FINAL_APPROVED_BY, 
      ad.FINAL_APPROVED_DT, 
      ad.DISPUTED_BY, 
      ad.DISPUTED_DT, 
      ad.DISCARDED_BY, 
      ad.DISCARDED_DT, 
      ad.VAULTED_BY, 
      ad.VAULTED_DT, 
      ad.CDTY_GROUP_CODE, 
      ad.CPTY_SN,    
	  ad.BROKER_SN, 
      ad.DOC_TYPE_CODE, 
      ad.SEC_VALIDATE_REQ_FLAG, 
      ad.TRADE_RQMT_ID, 
      ConfirmMgr.F_ASSOCIATED_TRADE_IDS(ad.INBOUND_DOCS_ID) AS tradeids, 
      sum(
         CASE 
            WHEN ad.DOC_STATUS_CODE IN ( 'ASSOCIATED', 'PRE-APPROVED', 'UNASSOCIATED', 'DISPUTED' ) THEN 1
            ELSE 0
         END) OVER(PARTITION BY ad.INBOUND_DOCS_ID) AS unresolvedcount, 
      ad.XMIT_STATUS_CODE, 
      ad.XMIT_VALUE
   FROM ConfirmMgr.ASSOCIATED_DOCS  AS ad, ConfirmMgr.INBOUND_DOCS  AS ib
   WHERE ib.DOC_STATUS_CODE = 'OPEN' AND ad.INBOUND_DOCS_ID = ib.ID


GO

GRANT SELECT TO stanford_developers 
GO
